name: Shallow Nabla + Cache (with checkout)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  nabla-checkout:
    runs-on: windows-2022
    steps:
      - name: Checkout (shallow, no submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'false'
          filter: blob:none
          show-progress: false

      - name: Restore git objects cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .git-mirror/nabla.git
            .git/modules
          key: nabla-mirror-
          restore-keys: |
            nabla-mirror-

      - name: Ensure mirror up-to-date for current ref
        shell: pwsh
        run: |
          if (-not (Test-Path '.git-mirror')) { New-Item -ItemType Directory -Path .git-mirror | Out-Null }
          if (-not (Test-Path '.git-mirror/nabla.git')) {
            git clone --mirror --filter=blob:none https://github.com/${env:GITHUB_REPOSITORY}.git .git-mirror/nabla.git
          }
          $ref = $env:GITHUB_REF
          if ($ref -like 'refs/pull/*') {
            git --git-dir .git-mirror/nabla.git fetch --filter=blob:none --no-tags --force origin "$ref"
          } else {
            git --git-dir .git-mirror/nabla.git fetch --filter=blob:none --no-tags --force origin "$env:GITHUB_SHA"
          }

      - name: Init submodules (shallow + parallel)
        shell: pwsh
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global protocol.version 2
          git config --global fetch.parallel 64
          git config --global checkout.workers 16
          git config --global http.version HTTP/2
          git submodule sync --recursive
          git -c submodule.alternateLocation=superproject -c submodule.alternateErrorStrategy=info -c submodule.fetchJobs=64 submodule update --init --recursive --depth 1 --jobs 64 --recommend-shallow

      - name: Save git objects cache (only our repo)
        if: >
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        uses: actions/cache/save@v4
        with:
          path: |
            .git-mirror/nabla.git
            .git/modules
          key: nabla-mirror-${{ github.run_id }}

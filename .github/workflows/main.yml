name: Badge Test

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-windows:
    runs-on: windows-2022
    if: github.event_name != 'pull_request'
    permissions:
      contents: write

    steps:
      - name: Update Badges
        run: |
          $image = "mcr.microsoft.com/windows/servercore:ltsc2022"
          docker pull $image | Out-Null
          $size = docker image ls $image --format "{{.Size}}"
          $badgeJson = @{
            schemaVersion = 1
            label = $image
            message = $size
            color = "blue"
          } | ConvertTo-Json -Depth 2
          $path = ".badge-public/packages/nabla-shader-compiler-nsc"
          New-Item -ItemType Directory -Path $path -Force | Out-Null
          $badgeJson | Set-Content -Path "$path/image-badge.json" -Encoding utf8

      - name: Deploy Github Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: badges
          publish_dir: .badge-public
          keep_files: true
          commit_message: "auto repository badge status update, dispatched from ${{ github.sha }}"

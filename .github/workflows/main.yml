name: Test Matrix + Separate Check Run

on:
  push:
  pull_request:

permissions:
  contents: write
  checks: write

jobs:
  matrix-job:
    name: Matrix Job (config=${{ matrix.config }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [Debug, Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run step and capture status
        id: test-step
        run: |
          echo "Running matrix config: ${{ matrix.config }}"
          if [[ "${{ matrix.config }}" == "Debug" ]]; then
            echo "Simulating failure for Debug"
            false  # this simulates failure
          else
            echo "Simulating success for Release"
            true
          fi
        continue-on-error: true

      - name: Set outcome output
        id: outcome
        run: |
          if [ "${{ steps.test-step.outcome }}" == "success" ]; then
            echo "conclusion=success" >> $GITHUB_OUTPUT
          else
            echo "conclusion=failure" >> $GITHUB_OUTPUT
          fi

      - name: Create custom check run
        if: always()
        uses: LouisBrunner/checks-action@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Build Examples (config=${{ matrix.config }})
          conclusion: ${{ steps.outcome.outputs.conclusion }}
          output: |
            {
              "title": "${{ steps.outcome.outputs.conclusion == 'success' && 'Build passed' || 'Build failed' }}",
              "summary": "Matrix config \`${{ matrix.config }}\` finished with status \`${{ steps.outcome.outputs.conclusion }}\`.\n\n[View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            }

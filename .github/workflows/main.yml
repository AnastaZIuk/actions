name: Shallow Nabla (master cache)

on:
  workflow_dispatch:

jobs:
  checkout-master-fast:
    runs-on: windows-2022
    steps:
      - name: Restore bare cache (master only)
        uses: actions/cache@v4
        with:
          path: .git-cache/nabla-bare.git
          key: nabla-bare-master-${{ runner.os }}-v1

      - name: Ensure bare cache (master)
        shell: pwsh
        run: |
          $bare = ".git-cache/nabla-bare.git"
          if (-not (Test-Path ".git-cache")) { New-Item -ItemType Directory -Path .git-cache | Out-Null }
          if (-not (Test-Path $bare)) {
            git init --bare $bare
            git -C $bare remote add origin https://github.com/Devsh-Graphics-Programming/Nabla.git
            git -C $bare config remote.origin.promisor true
            git -C $bare config remote.origin.partialclonefilter blob:none
          }
          git -C $bare remote set-branches origin master
          git -C $bare fetch --no-tags --depth 1 origin +refs/heads/master:refs/heads/master

      - name: Shallow clone from cache
        shell: pwsh
        run: |
          git clone --filter=blob:none --reference-if-able .git-cache/nabla-bare.git --dissociate --depth 1 --single-branch --branch master https://github.com/Devsh-Graphics-Programming/Nabla.git nabla

      - name: Restore submodules object cache
        uses: actions/cache@v4
        with:
          path: nabla/.git/modules
          key: nabla-submods-master-${{ runner.os }}-v1-${{ hashFiles('nabla/.gitmodules') }}
          restore-keys: |
            nabla-submods-master-${{ runner.os }}-v1-

      - name: Init submodules (shallow + parallel)
        shell: pwsh
        run: |
          cd nabla
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global protocol.version 2
          git config --global fetch.parallel 64
          git config --global checkout.workers 16
          git config --global http.version HTTP/2
          git submodule sync --recursive
          git -c submodule.alternateLocation=superproject -c submodule.alternateErrorStrategy=info -c submodule.fetchJobs=64 submodule update --init --recursive --depth 1 --jobs 64 --recommend-shallow

      - name: Summary
        shell: pwsh
        run: |
          cd nabla
          git rev-parse HEAD
          git submodule status --recursive

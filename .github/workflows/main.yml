name: Build

on:
  push:
  pull_request:

permissions:
  contents: write
  checks: write

jobs:
  matrix-job:
    name: Nabla (${{ matrix.vendor }}, ${{ matrix.config }}, ${{ matrix.tag }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        vendor: [msvc]
        config: [Release, Debug, RelWithDebInfo]
        tag: ['17.13.6']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Examples - Check run (REST, In-Progress)
        uses: LouisBrunner/checks-action@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Examples (${{ matrix.vendor }}, ${{ matrix.config }}, ${{ matrix.tag }})
          status: in_progress

      - name: Container â€“ Build Examples
        id: build-examples
        continue-on-error: true
        run: |
          echo "Running matrix config: ${{ matrix.config }}"
          sleep 10
          if [[ "${{ matrix.config }}" == "Debug" ]]; then
            echo "Simulating failure for Debug"
            false
          else
            echo "Simulating success"
            true
          fi

      - name: Examples - Check run (Set Conclusion)
        id: outcome-examples
        run: |
          if [ "${{ steps.build-examples.outcome }}" == "success" ]; then
            echo "conclusion=success" >> $GITHUB_OUTPUT
          else
            echo "conclusion=failure" >> $GITHUB_OUTPUT
          fi

      - name: Examples - Check run (REST, Completed)
        if: always()
        uses: LouisBrunner/checks-action@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Examples (${{ matrix.vendor }}, ${{ matrix.config }}, ${{ matrix.tag }})
          conclusion: ${{ steps.outcome-examples.outputs.conclusion }}
          started_at: ${{ steps.timing.outputs.started_at }}
          output: |
            {
              "title": "${{ steps.outcome-examples.outputs.conclusion }}",
              "summary": "Click [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) too see details."
            }

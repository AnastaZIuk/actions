name: Build

on:
  push:
  pull_request:

permissions:
  contents: write
  checks: write

jobs:
  matrix-job:
    name: Nabla (${{ matrix.os }}, ${{ matrix.vendor }}:${{ matrix.tag }}, ${{ matrix.config }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        vendor: [msvc]
        config: [Release, Debug, RelWithDebInfo]
        tag: ['17.13.6']
        os: [windows-2022]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Examples - Check run (Create)
        id: check-run-create
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const response = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: `Examples (${{ matrix.os }}, ${{ matrix.vendor }}:${{ matrix.tag }}, ${{ matrix.config }})`,
              head_sha: context.sha,
              status: 'in_progress'
            });
            return response.data.id;

      - name: Container â€“ Build Examples
        id: build-examples
        continue-on-error: true
        run: |
          echo "Running matrix config: ${{ matrix.config }}"
          sleep 10
          if [[ "${{ matrix.config }}" == "Debug" ]]; then
            echo "Simulating failure for Debug"
            false
          else
            echo "Simulating success"
            true
          fi

      - name: Examples - Check run (Set Conclusion)
        id: outcome-examples
        run: |
          completed_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          if [ "${{ steps.build-examples.outcome }}" == "success" ]; then
            echo "conclusion=success" >> $GITHUB_OUTPUT
          else
            echo "conclusion=failure" >> $GITHUB_OUTPUT
          fi
          echo "completed_at=$completed_at" >> $GITHUB_OUTPUT

      - name: Examples - Check run (Update)
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: ${{ steps.check-run-create.outputs.result }},
              status: 'completed',
              conclusion: '${{ steps.outcome-examples.outputs.conclusion }}',
              completed_at: '${{ steps.outcome-examples.outputs.completed_at }}',
              output: {
                title: '',
                summary: '[View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) to see details.'
              }
            });
